<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Payment Logs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: "Inter", sans-serif;
    }
    h1, h2, h3, h4 {
      font-family: "Oswald", sans-serif;
    }
    .text-accent { color: #fec400; }
    .bg-accent { background-color: #fec400; }
  </style>
</head>
<body class="bg-black text-white min-h-screen">

  <div class="max-w-7xl mx-auto px-6 py-12">
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-2 uppercase">Payment Logs</h1>
      <p class="text-gray-400">View all ClubReady payment transactions and API logs</p>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-sm p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold uppercase">Database Connection</h2>
        <button onclick="refreshLogs()" class="px-4 py-2 bg-accent text-black font-semibold rounded hover:bg-yellow-500 transition-colors">
          Refresh
        </button>
      </div>
      <div id="status" class="text-sm text-gray-400">Loading...</div>
    </div>

    <div class="grid gap-6">
      <!-- Payment Logs -->
      <div class="bg-white/5 border border-white/10 rounded-sm p-6">
        <h2 class="text-xl font-bold uppercase mb-4">Payment Logs</h2>
        <div id="payment-logs" class="space-y-3">
          <div class="text-center text-gray-400 py-8">Loading...</div>
        </div>
      </div>

      <!-- Prospects -->
      <div class="bg-white/5 border border-white/10 rounded-sm p-6">
        <h2 class="text-xl font-bold uppercase mb-4">Recent Prospects</h2>
        <div id="prospects-logs" class="space-y-3">
          <div class="text-center text-gray-400 py-8">Loading...</div>
        </div>
      </div>
    </div>

    <!-- How to Check ClubReady -->
    <div class="mt-8 bg-blue-500/10 border border-blue-500/30 rounded-sm p-6">
      <h3 class="text-lg font-bold mb-3 text-blue-400">How to Check ClubReady Dashboard</h3>
      <ol class="space-y-2 text-sm text-gray-300">
        <li><strong>1.</strong> Log in to your ClubReady admin dashboard</li>
        <li><strong>2.</strong> Go to <strong>Reports → Transactions</strong> or <strong>Sales → Transactions</strong></li>
        <li><strong>3.</strong> Filter by today's date</li>
        <li><strong>4.</strong> Look for transactions matching your test amounts</li>
        <li><strong>5.</strong> Check <strong>Members → Prospects</strong> to see newly created prospects</li>
      </ol>
      <p class="mt-4 text-xs text-gray-500">Note: Test mode transactions (from localhost) will NOT appear in ClubReady.</p>
    </div>
  </div>

  <script type="module">
    const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
    const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

    async function loadLogs() {
      try {
        const paymentResponse = await fetch(`${SUPABASE_URL}/rest/v1/payment_logs?order=created_at.desc&limit=20`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          },
        });

        const prospectsResponse = await fetch(`${SUPABASE_URL}/rest/v1/prospects?order=created_at.desc&limit=10`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          },
        });

        const paymentLogs = await paymentResponse.json();
        const prospects = await prospectsResponse.json();

        document.getElementById('status').innerHTML = `
          <span class="text-green-400">✓ Connected</span> |
          <span class="text-gray-400">${paymentLogs.length} payment logs, ${prospects.length} prospects</span>
        `;

        renderPaymentLogs(paymentLogs);
        renderProspects(prospects);
      } catch (error) {
        console.error('Error loading logs:', error);
        document.getElementById('status').innerHTML = `<span class="text-red-400">✗ Error: ${error.message}</span>`;
      }
    }

    function renderPaymentLogs(logs) {
      const container = document.getElementById('payment-logs');

      if (!logs || logs.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-8 bg-black border border-white/5 rounded">
            <p class="mb-2">No payment logs found</p>
            <p class="text-xs text-gray-500">Payments made in test mode (localhost) are not logged</p>
          </div>
        `;
        return;
      }

      container.innerHTML = logs.map(log => `
        <div class="bg-black border border-white/10 rounded p-4">
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-1">
                <div class="font-semibold text-white">${log.endpoint || log.action || 'Payment'}</div>
                ${log.step ? `<span class="px-2 py-0.5 bg-blue-500/20 text-blue-400 text-xs rounded">${log.step}</span>` : ''}
                ${log.http_status || log.status_code ? `
                  <span class="px-2 py-0.5 ${
                    (log.http_status || log.status_code) >= 200 && (log.http_status || log.status_code) < 300
                      ? 'bg-green-500/20 text-green-400'
                      : 'bg-red-500/20 text-red-400'
                  } text-xs rounded font-mono">
                    ${log.http_status || log.status_code}
                  </span>
                ` : ''}
              </div>
              <div class="text-xs text-gray-500">${new Date(log.created_at).toLocaleString()}</div>
              ${log.api_url ? `<div class="text-xs text-gray-400 mt-1 font-mono">${log.api_url}</div>` : ''}
              ${log.clubready_request_id ? `<div class="text-xs text-purple-400 mt-1">Request ID: ${log.clubready_request_id}</div>` : ''}
              ${log.duration_ms ? `<div class="text-xs text-gray-500 mt-1">Duration: ${log.duration_ms}ms</div>` : ''}
            </div>
            <div class="px-3 py-1 rounded text-xs font-semibold ${
              log.success || ((log.http_status || log.status_code) >= 200 && (log.http_status || log.status_code) < 300)
                ? 'bg-green-500/20 text-green-400'
                : 'bg-red-500/20 text-red-400'
            }">
              ${log.success || ((log.http_status || log.status_code) >= 200 && (log.http_status || log.status_code) < 300) ? 'Success' : 'Failed'}
            </div>
          </div>
          ${log.request_headers ? `
            <div class="mt-3 text-xs">
              <details class="cursor-pointer">
                <summary class="text-gray-400 mb-1 hover:text-white">Request Headers</summary>
                <pre class="bg-white/5 p-2 rounded overflow-x-auto text-gray-300 mt-1">${JSON.stringify(log.request_headers, null, 2)}</pre>
              </details>
            </div>
          ` : ''}
          ${log.request_body || log.request_data ? `
            <div class="mt-3 text-xs">
              <details class="cursor-pointer">
                <summary class="text-gray-400 mb-1 hover:text-white">Request Body</summary>
                <pre class="bg-white/5 p-2 rounded overflow-x-auto text-gray-300 mt-1">${JSON.stringify(log.request_body || log.request_data, null, 2)}</pre>
              </details>
            </div>
          ` : ''}
          ${log.response_data ? `
            <div class="mt-3 text-xs">
              <details class="cursor-pointer">
                <summary class="text-gray-400 mb-1 hover:text-white">Response</summary>
                <pre class="bg-white/5 p-2 rounded overflow-x-auto text-gray-300 mt-1">${JSON.stringify(log.response_data, null, 2)}</pre>
              </details>
            </div>
          ` : ''}
          ${log.error_details ? `
            <div class="mt-3 text-xs">
              <div class="text-red-400 font-semibold mb-1">Error Details:</div>
              <pre class="bg-red-500/10 p-2 rounded overflow-x-auto text-red-300">${JSON.stringify(log.error_details, null, 2)}</pre>
            </div>
          ` : ''}
          ${log.error_message ? `
            <div class="mt-3 text-xs text-red-400">
              <div class="font-semibold mb-1">Error Message:</div>
              <div class="bg-red-500/10 p-2 rounded">${log.error_message}</div>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function renderProspects(prospects) {
      const container = document.getElementById('prospects-logs');

      if (!prospects || prospects.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-8 bg-black border border-white/5 rounded">
            <p class="mb-2">No prospects found</p>
            <p class="text-xs text-gray-500">Prospects are only created when completing the checkout flow</p>
          </div>
        `;
        return;
      }

      container.innerHTML = prospects.map(prospect => `
        <div class="bg-black border border-white/10 rounded p-4">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="font-semibold text-white mb-1">
                ${prospect.first_name} ${prospect.last_name}
              </div>
              <div class="text-sm text-gray-400 space-y-1">
                <div>Email: ${prospect.email}</div>
                <div>Phone: ${prospect.phone}</div>
                ${prospect.clubready_user_id ? `<div class="text-accent">ClubReady ID: ${prospect.clubready_user_id}</div>` : ''}
              </div>
            </div>
            <div class="text-xs text-gray-500">
              ${new Date(prospect.created_at).toLocaleString()}
            </div>
          </div>
        </div>
      `).join('');
    }

    window.refreshLogs = loadLogs;

    loadLogs();
  </script>

</body>
</html>
